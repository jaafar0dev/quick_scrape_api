<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Word Frequency</title>

    <!-- Bootstrap for quick, clean styling -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
      body {
        background: linear-gradient(120deg, #f7f9fc, #eef6ff);
        min-height: 100vh;
      }
      .card {
        border: 0;
        border-radius: 12px;
        box-shadow: 0 6px 20px rgba(23, 43, 77, 0.08);
      }
      .chart-wrap {
        padding: 1.25rem;
        min-height: 420px;
      }
      canvas {
        width: 100% !important;
        height: 360px !important;
      }
      .top-list {
        max-height: 320px;
        overflow: auto;
      }
      .word-pill {
        font-weight: 600;
        color: #123;
      }
      .count-badge {
        background: linear-gradient(90deg, #6ea8fe, #2b7de9);
        color: #fff;
      }
    </style>
  </head>
  <body>
    <div class="container py-5">
      <div class="row g-4 align-items-start">
        <div class="col-12">
          <form id="scrapeForm" class="d-flex gap-2 mb-3">
            <input
              id="urlInput"
              class="form-control"
              type="url"
              placeholder="https://example.com"
              required
            />
            <button id="scrapeBtn" class="btn btn-primary" type="submit">
              Scrape
            </button>
            <div
              id="scrapeStatus"
              class="ms-2 align-self-center text-muted"
              style="min-width: 180px"
            >
              Ready
            </div>
          </form>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="chart-wrap">
              <div
                class="d-flex justify-content-between align-items-center mb-2"
              >
                <h5 class="mb-0">Word Frequency (Top terms)</h5>
                <small class="text-muted">Visualized using Chart.js</small>
              </div>
              <canvas
                id="wordChart"
                aria-label="Word frequency chart"
                height="360"
              ></canvas>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="mb-0">Top Words</h6>
              <small class="text-muted">Sorted by frequency</small>
            </div>

            <div class="top-list mt-2">
              <ul id="topList" class="list-group list-group-flush">
                <li class="list-group-item text-muted">No data available</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const TOP_N = 20;

      // Create gradient for bars
      const ctx = document.getElementById("wordChart").getContext("2d");
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, "rgba(43,125,233,0.92)");
      gradient.addColorStop(1, "rgba(110,168,254,0.85)");

      // Initialize chart with empty data
      const wordChart = new Chart(ctx, {
        type: "bar",
        data: {
          labels: [],
          datasets: [
            {
              label: "Occurrences",
              data: [],
              backgroundColor: gradient,
              borderRadius: 6,
              barPercentage: 0.8,
              categoryPercentage: 0.8,
              maxBarThickness: 32,
              hoverBackgroundColor: "rgba(43,125,233,0.98)",
            },
          ],
        },
        options: {
          indexAxis: "y",
          responsive: true,
          maintainAspectRatio: false,
          elements: {
            bar: {
              maxBarThickness: 36,
            },
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: { precision: 0 },
              grid: { color: "rgba(15,31,66,0.06)" },
            },
            y: {
              grid: { display: false },
              ticks: { color: "#123" },
            },
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: (ctx) => `${ctx.parsed.x} occurrences`,
              },
            },
          },
        },
      });

      // Helper to update chart and list
      function updateChartAndList(labels, values) {
        const l = labels.slice(0, TOP_N);
        const v = values.slice(0, TOP_N);

        // Update chart
        wordChart.data.labels = l;
        wordChart.data.datasets[0].data = v;
        wordChart.update();

        // Update list
        const ul = document.getElementById("topList");
        if (!ul) return;
        ul.innerHTML = "";

        if (l.length === 0) {
          ul.innerHTML =
            '<li class="list-group-item text-muted">No data available</li>';
          return;
        }

        for (let i = 0; i < l.length; i++) {
          const li = document.createElement("li");
          li.className =
            "list-group-item d-flex justify-content-between align-items-center";
          li.innerHTML = `<span class="word-pill">${l[i]}</span><span class="badge count-badge rounded-pill">${v[i]}</span>`;
          ul.appendChild(li);
        }
      }

      // Load latest data on page load
      async function loadLatestData() {
        try {
          const res = await fetch("/data");
          if (!res.ok) return;
          const payload = await res.json();
          if (payload.labels && payload.labels.length > 0) {
            updateChartAndList(payload.labels, payload.values);
            document.getElementById("scrapeStatus").textContent = `Loaded: ${
              payload.url || "previous data"
            }`;
          }
        } catch (err) {
          console.error("Failed to load data:", err);
        }
      }

      // Load data on page load
      loadLatestData();

      // Wire up form to trigger scraping
      const form = document.getElementById("scrapeForm");
      const urlInput = document.getElementById("urlInput");
      const status = document.getElementById("scrapeStatus");
      const btn = document.getElementById("scrapeBtn");

      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const url = urlInput.value && urlInput.value.trim();
          if (!url) return;

          try {
            status.textContent = "Scraping...";
            btn.disabled = true;

            const res = await fetch("/scrape", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: new URLSearchParams({ url }),
            });

            const payload = await res.json();

            if (!res.ok) {
              status.textContent = payload.error || "Scrape failed";
              return;
            }

            status.textContent = "Fetching results...";

            // Fetch the scraped data
            const id = payload.id;
            const dataRes = await fetch(`/data?id=${id}`);
            const data = await dataRes.json();

            // Update the visualization
            updateChartAndList(data.labels || [], data.values || []);
            status.textContent = `Scraped: ${data.url || url}`;
          } catch (err) {
            console.error(err);
            status.textContent = "Error during scrape";
          } finally {
            btn.disabled = false;
          }
        });
      }
    </script>
  </body>
</html>
